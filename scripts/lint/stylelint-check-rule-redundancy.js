#!/usr/bin/env node

import localConfig from "../../.stylelintrc.json" with { type: "json" };
import console from "node:console";
import process from "node:process";
import stylelint from "stylelint";

try {
  const customRules = localConfig.rules || {};
  const customRuleNames = Object.keys(customRules);

  if (customRuleNames.length === 0) {
    console.log("‚úÖ No custom rules defined to check for redundancy");
    process.exit(0);
  }

  // Get the extended config without custom rules
  // Create a temporary config with only the extends, no custom rules
  const extendsOnlyConfig = {
    extends: localConfig.extends || [],
  };

  const resolvedExtendsConfig = await stylelint.resolveConfig(".", {
    config: extendsOnlyConfig,
  });

  if (!resolvedExtendsConfig) {
    console.log("‚ùå Could not resolve extended stylelint config");
    process.exit(1);
  }

  const extendedRules = resolvedExtendsConfig.rules || {};

  // Find redundant rules
  const redundant = customRuleNames.filter((ruleName) => {
    const customValue = customRules[ruleName];
    const extendedValue = extendedRules[ruleName];

    if (extendedValue !== undefined) {
      // Normalize values for comparison (stylelint accepts both array and scalar formats)
      const normalizeValue = (value) => {
        if (Array.isArray(value) && value.length === 1) {
          return value[0];
        }
        return value;
      };

      const normalizedCustom = normalizeValue(customValue);
      const normalizedExtended = normalizeValue(extendedValue);

      // Compare rule values
      const customString = JSON.stringify(customValue);
      const extendedString = JSON.stringify(extendedValue);
      const normalizedCustomString = JSON.stringify(normalizedCustom);
      const normalizedExtendedString = JSON.stringify(normalizedExtended);

      if (customString === extendedString) {
        console.log(
          `‚ùå ${ruleName}: identical to extended config (${extendedString})`,
        );
        return true;
      }

      if (
        normalizedCustomString === normalizedExtendedString &&
        customString !== extendedString
      ) {
        console.log(
          `‚ùå ${ruleName}: semantically identical to extended config (extended: ${extendedString}, yours: ${customString})`,
        );
        return true;
      }

      console.log(
        `‚ö†Ô∏è  ${ruleName}: overrides extended config (extended: ${extendedString}, yours: ${customString})`,
      );
    }
    return false;
  });

  if (redundant.length === 0) {
    console.log("‚úÖ No redundant stylelint rules found");
    console.log(`üìä ${customRuleNames.length} custom rules checked`);
  } else {
    console.log(`‚ùå ${redundant.length} redundant rules found`);
  }
} catch (error) {
  console.log("‚ùå Error checking stylelint rule redundancy:", error.message);
  process.exit(1);
}
